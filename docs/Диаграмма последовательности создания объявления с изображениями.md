# Диаграмма последовательности создания объявления с изображениями
# https://www.mermaidonline.live/ru/sequence

```mermaid
sequenceDiagram
    participant U as Пользователь
    participant AF as AdForm
    participant AS as Ads Service
    participant API as API Endpoint
    participant AM as Auth Middleware
    participant UM as Upload Middleware
    participant AH as Ad Handler
    participant AD_S as Ad Service
    participant AD_R as Ad Repository
    participant DB as PostgreSQL

    U->>AF: Заполняет форму объявления
    U->>AF: Выбирает изображения
    U->>AF: Нажимает "Создать объявление"
    
    AF->>AS: createWithImages(adData, images)
    AS->>API: POST /ads/with-images (multipart/form-data)
    
    API->>AM: Auth Middleware
    AM->>AM: Проверяет JWT токен
    AM->>AM: Извлекает userID из токена
    AM->>UM: Upload Middleware
    
    UM->>UM: Проверяет размер и тип файлов
    UM->>UM: Сохраняет файлы в uploads/images
    UM->>UM: Устанавливает uploadedFiles в контекст
    UM->>AH: CreateAdWithImages handler
    
    AH->>AH: Извлекает userID из контекста
    AH->>AH: Извлекает данные из формы
    AH->>AH: Валидирует данные
    AH->>AD_S: CreateAdWithImages(ad, imagePaths)
    
    AD_S->>AD_R: CreateAdWithImages(ad, imagePaths)
    AD_R->>DB: Начинает транзакцию
    AD_R->>DB: Создает запись объявления
    AD_R->>DB: Создает записи изображений
    AD_R->>DB: Завершает транзакцию
    
    DB-->>AD_R: Возвращает результат транзакции
    AD_R-->>AD_S: Возвращает результат
    AD_S-->>AH: Возвращает результат
    AH->>API: Возвращает JSON с объявлением
    API-->>AS: Отправляет ответ
    AS-->>AF: Возвращает данные объявления
    AF->>U: Перенаправляет на страницу объявления